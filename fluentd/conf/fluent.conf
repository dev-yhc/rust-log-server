<source>
  @type tail
  path /app/logs/application.log
  pos_file /fluentd/log/application.log.pos
  tag app.logs
  <parse>
    @type regexp
    expression /^(?<time>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) \[(?<level>\w+)\] (?<service>\w+) - (?<message>.*)$/
    time_format %Y-%m-%d %H:%M:%S
  </parse>
</source>

<match app.logs>
  @type s3
  s3_bucket adserver-log-20250303
  s3_region ap-northeast-2
  path year=%Y/month=%m/day=%d/
  s3_object_key_format %{path}%{time_slice}_%{index}.log
  store_as gzip

  <buffer time>
    @type file
    path /fluentd/log/s3
    timekey 60
    timekey_wait 10s
    timekey_use_utc true
    chunk_limit_size 256m
  </buffer>

  <format>
    @type json
  </format>

  time_slice_format %Y%m%d-%H%M
  utc
</match>
