<source>
  @type tail
  path /fluentd/log/application.log
  pos_file /fluentd/log/application.log.pos
  tag app.logs
  <parse>
    @type regexp
    expression /^(?<time>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) \[(?<level>\w+)\] (?<ip>[\d\.]+) - (?<message>.*)$/
    time_format %Y-%m-%d %H:%M:%S
  </parse>
</source>

<match app.logs>
  @type s3_parquet

  s3_bucket ad-log
  s3_region ap-northeast-2
  path logs/year=%Y/month=%m/day=%d/
  s3_object_key_format %{path}%{time_slice}_%{index}.parquet

  <buffer time>
    @type file
    path /fluentd/log/s3
    timekey 3600 # 1 hour partition
    timekey_wait 10m
    timekey_use_utc true # use utc
    chunk_limit_size 256m
  </buffer>

  compression_codec snappy

  <schema>
    time timestamp
    level string
    ip string
    message string
  </schema>

  time_slice_format %Y%m%d-%H
  utc

  # Use IAM role or specify credentials
  <assume_role_credentials>
    role_arn arn:aws:iam::your-account-id:role/s3_log_role
    role_session_name fluentd-s3-session
  </assume_role_credentials>
</match>
