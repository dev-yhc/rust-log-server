<source>
  @type tail
  path /fluentd/log/application.log
  pos_file /fluentd/log/application.log.pos
  tag app.logs
  <parse>
    @type regexp
    expression /^(?<time>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) \[(?<level>\w+)\] (?<ip>[\d\.]+) - (?<message>.*)$/
    time_format %Y-%m-%d %H:%M:%S
  </parse>
</source>

<match app.logs>
  @type s3

  s3_bucket your-bucket-name
  s3_region your-bucket-region
  path logs/%Y/%m/%d/
  s3_object_key_format %{path}%{time_slice}_%{index}.%{file_extension}

  <buffer time>
    @type file
    path /fluentd/log/s3
    timekey 3600 # 1 hour partition
    timekey_wait 10m
    timekey_use_utc true # use utc
  </buffer>

  <format>
    @type json
  </format>

  time_slice_format %Y%m%d-%H
  time_slice_wait 10m
  utc

  # Use IAM role or specify credentials
  <assume_role_credentials>
    role_arn arn:aws:iam::your-account-id:role/your-role-name
    role_session_name fluentd-session
  </assume_role_credentials>
</match>
